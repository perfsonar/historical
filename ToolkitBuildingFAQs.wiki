#summary Information for building various components of the Toolkit

== Introduction ==

This page contains information about building the various components of the Toolkit.


== Kernel ==
The Toolkit includes a patched version of the CentOS 5 version of the Linux kernel.

To build this kernel, you will need a host with CentOS 5, and the rpm-build, kernel-devel, redhat-rpm-config and unifdef packages installed.

  * Download the most recent kernel Source RPM for CentOS 5.5. This can be found at http://wiki.centos.org/HowTos/I_need_the_Kernel_Source. 
  * Install the kernel source RPM. This should install files into your RPM build directory (typically /usr/src/redhat if root)
  * Download http://anonsvn.internet2.edu/svn/nptoolkit/trunk/software/kernel/srpm_patches/el5/sources.patch
    * This patch will perform a couple tasks:
      * Adds the web100 patch to the SOURCES directory
      * Modifies the default kernel config to include the web100 options.
  * cd to the 'SOURCES' directory in your RPM build directory
  * Run 'patch -i sources.patch -p0'
  * cd to the 'SPECS' directory in your RPM build directory
  * Download http://anonsvn.internet2.edu/svn/nptoolkit/trunk/software/kernel/srpm_patches/el5/kernel-2.6_spec.patch
    * This patch attempts a few tasks:
      * Set the buildid to .web100 so that the kernel version will be of the form 2.6.18-194.32.1.el5.web100
      * Adds the web100 patch to the list of available patches
      * Adds a line to tell the build process to apply the web100 patch
      * Attempts to update the changelog at the bottom to note the changes
  * cd to the 'SPECS' directory in your RPM build directory
  * Run 'patch -i kernel-2.6_spec.patch'. This patches kernel.spec. Copy that to kernel-2.6.spec after patching and making any needed changes.
    * Note: it is likely that one or more of the patch changes may fail (especially the changelog one). If this happens, the changes will need to be applied manually to the kernel-2.6.spec. Look at the generated .rej file to see which changes need to be made to the spec file.
  * Further changes can be made as needed
    * To set a new buildid, edit the 'kernel-2.6.spec' in the 'SPECS' directory of your RPM build directory and set an appropriate buildid (e.g. .web100.custom)
    * To add more patches, edit the 'kernel-2.6.spec', and follow the example for adding the web100 patches in the 'kernel-2.6_spec.patch'
      * Add a line to tell the spec file about the new patch. E.g. add a line like: Patch30001: custom.patch
        * Take note of the patch number specified
      * Add a line to tell the build process to apply the new patch you. E.g. add a line like: %patch30001 -p1
    * To change the default kernel configuration edit the file 'config-rhel-generic' in the 'SOURCES' directory of your RPM build directory
    * Update the changelog at the bottom 'kernel-2.6.spec' file to note any changes you've made
  * To build the kernel, run: rpmbuild -ba --target=i686 --without debug --without kabichk kernel-2.6.spec 2> build-err.log | tee build-out.log 
    * Note: the above command will put error messages into the file 'build-err.log'
    * Note: If the error is about missing web100 file patch, you can download one from [http://anonsvn.internet2.edu/svn/nptoolkit/trunk/software/kernel/srpm_patches/el5/web100-2.6.18-2.5.12-200609221010.patch here]. 
    * If new patches have been added, this command may error out due to patches that don't apply cleanly. If so, these patches will need modified as appropriate and the command rerun.
  * To build the kernel headers (needed for building modules later), run: rpmbuild -ba --target=i386 --with headers kernel-2.6.spec 2> build-err.log | tee build-out.log
  * The RPMs (and a new SRPM) should now be available in the RPMS and SRPMS directories in your RPM build directory. They can either be installed directly, or added to a yum repository and installed via that method.

=== Generating Random Bytes ===
When compiling on a remote host, it is common to see an error like this:

{{{
Not enough random bytes available.  Please do some other work to give
the OS a chance to collect more entropy! (Need 266 more bytes)
}}}

There are a number of ways to generate random bytes on a remote machine, but the easiest way that we've found is to perform parallel 'hdparm' tests. The following script can be run one or more times in the event that the error above is seen.

{{{
#!/bin/bash

NUM_TESTS=20

if [ -n "$1" ]; then
    NUM_TESTS=$1
fi

for i in `seq 1 $NUM_TESTS`; do
    /sbin/hdparm -t /dev/sda1 &
done
}}}

== Customizing The Toolkit ==

The pS-Performance Toolkit, as both the LiveCD and NetInstall, are built using a custom CentOS kickstart file. You can read more about kickstart installations [http://docs.redhat.com/docs/en-US/Red_Hat_Enterprise_Linux/5/html/Installation_Guide/ch-kickstart2.html here]. The kickstart file defines the set of software repositories to use, the set of software to install, and a script that performs some system configuration once the software has been installed. Customizing the toolkit will involve changing one or more of those elements in the kickstart files.

=== Pre-Requisites ===

The build procedures here assume that the toolkit ISOs are being built on CentOS 5. The steps may work on other systems, but have only been tested on CentOS 5.

For building custom versions of either the LiveCD or NetInstall, you'll need a copy of Image Magick installed on the host. This should be available via yum. You will also need squashfs-tools.

For building custom versions of the NetInstall, you will need a copy of mkisofs installed on the host. This should be available via yum.

For building custom versions of the LiveCD, you will need the livecd-tools package installed on CentOS 5. You can find installation information [https://projects.centos.org/trac/livecd/wiki/GetToolset here].

=== Building The Toolkit ===

You can download the kickstarts, images and scripts needed to build the toolkit by doing a subversion checkout of http://anonsvn.internet2.edu/svn/nptoolkit/trunk/

There are 6 directories in this subversion repository. The ones of importance for customization are 'kickstarts', 'images', and 'scripts'. The 'kickstarts' directory contains the files used for generating the kickstarts used by the LiveCD and NetInstall setups. The 'scripts' directory contains 2 scripts used for building the toolkit, one for the NetInstall and one for the LiveCD. The 'images' directory contains the image displayed when the CD is first booted.

If you run the script 'build_livecd.sh' as root, it should download all the necessary RPMs, and build an ISO of the LiveCD and place it in the directory from which you ran the script. Similarly, if you run the script 'build_netinstall.sh' as root, it should build an ISO of the NetInstall.

The general build process of the LiveCD proceeds as follows:
  * Patches the 'generic' kickstart file (reference-platform.ks) with LiveCD-specific modifications (reference-platform-livecd.patch)
  * Calls livecd-creator to build the LiveCD from the kickstart file
  * Modifies the generated LiveCD to use the proper boot image

The general build process of the NetInstall roceeds as follows:
  * Patches the 'generic' kickstart file (reference-platform.ks) with NetInstall-specific modifications (reference-platform-netinstall.patch)
  * Modifies the generic CentOS netinstall CD (in the 'resources' directory) to include the kickstart and to boot using it
  * Modifies the generic CentOS netinstall CD to use the proper boot image

=== Customizing The Toolkit ===

To customize the toolkit, you will need to modify the kickstart file. The reference-platform.ks file in the kickstarts directory is the 'generic' kickstart file. There are 2 patches, reference-platform-livecd.ks and reference-platform-netinstall.ks, that modify this kickstart file.

There are a large number of directives inside the kickstart. The meaning of most of these is outside the scope of this document, but should be available [http://docs.redhat.com/docs/en-US/Red_Hat_Enterprise_Linux/5/html/Installation_Guide/ch-kickstart2.html here].

==== Customizing The Software Yum Repositories ====

The set of repositories that will be used to retrieve RPMs from can be customized. This allows you to use a local mirror to speed up builds as well as to include new or customized RPMs. Note, however, that when changing the repositories, you must make sure that the software to be installed (either directly or to satisfy dependencies) must still be available in the set of repositories.

The 'repo' lines specify the set of repositories to use:

{{{
repo --name=a-Internet2    --baseurl=http://software.internet2.edu/rpms/i386/main/
}}}

The above line tells the kickstart to use the Internet2 repository and gives the URL of the yum repository.

Note: the repositories here are only used for installation. They will not be available after installation. If you want to make these software repositories available after installation, you must either have the kickstart install an appropriate repository package (see [https://fedoraproject.org/wiki/EPEL/FAQ#How_can_I_install_the_packages_from_the_EPEL_software_repository.3F here] for an example of the repository package), or have the post installation script add the appropriate .repo and key files. 

==== Customizing The Software To Install ====

In the `%packages` section, there are a list of packages to install or not install. Any packages that start with "@" are package groups (e.g. `@core` is the set of core packages). Any packages that start with "-" are packages that should not be installed (e.g. `-sysreport` says to not install the sysreport package). All other packages are normal packages to install like you might do with yum.

You can add any packages here that you might want installed.

==== Customizing The Toolkit System Environment ====

The toolkit system environment can be configured using the %post script. This script is run after the software packages have been installed, and allow for modifications to be made to the installed system before it is booted for the first time (or, in the case of the LiveCD, before it is turned into an unmodifiable ISO).

There is an existing %post script that performs a number of tasks needed by the toolkit. However, this script can be modified to include any desired configuration for the toolkit system. For example, users could be added, or configuration files could be modified. The existing post installation script includes a wide variety of methods for configuring aspects of the installed system.

The thing to remember when making changes is that the patch files expect to patch the `reference-platform.ks` file. There are a few ways to go about making changes. One way is to make changes to the reference-platform.ks in such a way that they don't conflict with the patches. This is generally the path of least resistance. Another option, if you only plan on making one of the LiveCD or NetInstall, is to patch the reference-platform.ks before making your changes, and then edit the `build_netinstall.sh` or `build_livecd.sh` and set the `KICKSTART_PATCH=...` line to be `KICKSTART_PATCH=`. This will stop the script from trying to patch the `reference-platform.ks` file. Lastly, you can edit the reference-platform.ks, and the regenerate or edit the patch files to account for the changes.

== Building Toolkit Packages With `mock` ==

[ToolkitDevelopment_MockOverview This page] contains background information on mock. The latter sections assume basic knowledge of mock and 'holding' repositories, and that the holding repository has been configured as described.

[ToolkitDevelopment_SourceRPMs This page] contains information on creating and building source RPMs. The latter sections assume basic knowledge of building source RPMs.
=== i2_mock utility ===

To ease the use of mock, we built a simple wrapper script over the mock command which simply sets some default values:
  * The uniqueext value will be set to the callers username 
  * The architecture is set to "i386"
  * The default build environment is set to "epel-5" (RedHat5 + the EPEL repositories)
  * The output directory is set to /srv/results/[username]/[build environment]/[architecture]/[rpm name]

{{{
    #!/usr/bin/perl

    use strict;
    use warnings;

    use Getopt::Long;

    Getopt::Long::Configure("pass_through");
    Getopt::Long::Configure("no_ignore_case");

    my $uniqueext;
    my $resultdir;
    my $arch;
    my $distro;

    my $result = GetOptions("uniqueext=s", \$uniqueext,
                        "resultdir=s", \$resultdir,
                        "arch=s", \$arch,
                        "distro=s", \$distro);

    my @remaining_args = @ARGV;

    my $srpm = $ARGV[$#ARGV];
    unless ($srpm) {
            print "No source RPM specified\n";
            exit(-1);
    }

    unless (`rpm -qp $srpm 2>/dev/null`) {
        print "invalid SRPM: $srpm";
        exit(-1);
    }

    my  ($name, $pass, $uid, $gid, $quota, $comment, $gcos, $dir, $shell, $expire) = getpwuid($>);

    $arch="i386" unless ($arch);
    $distro="epel-5" unless ($distro);
    $uniqueext=$name unless ($uniqueext);
    $resultdir="/srv/results/$name/$distro/$arch/".`rpm -qp $srpm 2>/dev/null` unless ($resultdir);
    chomp($resultdir);

    my $mycfg = "$distro-$arch";
    $mycfg="$distro-i386" if ( ! -e "/etc/mock/$mycfg" and $arch eq "i686" and -e "/etc/mock/$distro-i386.cfg");

    my @args = ();
    push @args, ("/usr/bin/mock");
    push @args, ("-r", $mycfg);
    push @args, ("--resultdir", $resultdir);
    push @args, ("--uniqueext", $uniqueext);
    push @args, ("--arch", $arch);
    push @args, @remaining_args;

    print join(" ", @args)."\n";
    system(@args);
}}}

=== I2utils ===
  * Build a source RPM of I2utils (e.g. I2utils-1.1-1.src.rpm)
    * A copy of the source/spec file is available at svn checkout http://anonsvn.internet2.edu/svn/I2util/trunk I2Util
  * Run: `i2_mock [I2utils rpm]` (e.g. `i2_mock I2utils-1.1-1.src.rpm`)

=== bwctl ===
  * Place a built RPM of I2utils into the 'holding' repository
  * Build a source RPM of bwctl (e.g. bwctl-1.3-5.src.rpm)
    * A copy of the source/spec file is available at http://anonsvn.internet2.edu/svn/nptoolkit/trunk/software/bwctl/
  * Run: `i2_mock [bwctl rpm]` (e.g. `i2_mock bwctl-1.3-5.src.rpm`)

=== owamp ===
  * Place a built RPM of I2utils into the 'holding' repository
  * Build a source RPM of owamp (e.g. owamp-3.2rc4-1.src.rpm)
    * A copy of the source/spec file is available at http://anonsvn.internet2.edu/svn/nptoolkit/trunk/software/owamp/
  * Run: `i2_mock [owamp rpm]` (e.g. `i2_mock owamp-3.2rc4-1.src.rpm`)

=== web100_userland ===
  * Build a source RPM of web100_userland (e.g. web100_userland-1.7-1.src.rpm)
    * A copy of the source/spec file is available at http://perfsonar-ps.googlecode.com/git/Toolkit_Building/software/web100-userland/
  * Run: `i2_mock [web100_userland rpm]` (e.g. `i2_mock oweb100_userland-1.7-1.src.rpm)

=== ndt ===
  * Place a built RPM of I2utils into the 'holding' repository
  * Place a built RPM of web100_userland into the 'holding' repository
  * Build a source RPM of ndt (e.g. ndt-3.6.4-4.src.rpm)
    * A copy of the sources/spec file is available at http://anonsvn.internet2.edu/svn/nptoolkit/trunk/software/ndt/
  * Run: `i2_mock [ndt rpm]` (e.g. `i2_mock ndt-3.6.4-4.src.rpm)

=== npad ===
  * Place a built RPM of web100_userland into the 'holding' repository
  * Build a source RPM of npad (e.g. npad-1.5.6-1.src.rpm)
    * A copy of the sources/spec file is available at http://anonsvn.internet2.edu/svn/nptoolkit/trunk/software/npad/
  * Run: `i2_mock [npad rpm]` (e.g. `i2_mock npad-1.5.6-1.src.rpm)

=== nuttcp ===
  * Build a source RPM of nuttcp (e.g. nuttcp-6.1.2-1.src.rpm)
    * A copy of the sources/spec file is available at http://anonsvn.internet2.edu/svn/nptoolkit/trunk/software/nuttcp/
  * Run: `i2_mock [nuttcp rpm]` (e.g. `i2_mock nuttcp-6.1.2-1.src.rpm)

=== kernel ===
  * Build a source RPM of the kernel. This will involve steps described [#Kernel above]. (e.g. kernel-2.6.18-194.32.1.el5.web100.src.rpm)
  * Run `i2_mock --arch i686 --without debug --without kabichk [kernel rpm]` (e.g. `i2_mock --arch i686 --without debug --without kabichk ~/rpm/SRPMS/kernel-2.6.18-194.32.1.el5.web100.src.rpm`)
   * NOTE: make sure you have >5G of available disk space for building the set of kernels

=== aufs kernel module ===
  * Copy all the kernel development RPMs (*-devel-*rpm) into the 'holding' repository (i.e. i686, PAE and xen version)
    * Make note of the kernel version number (e.g. 2.6.18-194.32.1.el5.web100)
  * Build a source RPM of the aufs module (e.g. aufs-0.20090202.cvs-6.src.rpm)
    * A copy of the sources/spec file is available at http://perfsonar-ps.googlecode.com/git/Toolkit_Building/software/aufs/
  * Run `i2_mock --arch i686 -D "kernel [kernel version number]" [aufs rpm]` (e.g. `i2_mock --arch i686 -D "kernel 2.6.18-194.32.1.el5.web100" aufs-0.20090202.cvs-6.src.rpm)

=== ixgbe kernel module ===
  * Copy all the kernel development RPMs (*-devel-*rpm) into the 'holding' repository (i.e. i686, PAE and xen version)
    * Make note of the kernel version number (e.g. 2.6.18-194.32.1.el5.web100)
  * Build a source RPM of the ixgbe module (e.g. ixgbe-3.1.17-1.src.rpm)
    * A copy of the sources/spec file is available at http://anonsvn.internet2.edu/svn/nptoolkit/trunk/software/ixgbe/
  * Run `i2_mock --arch i686 -D "kversion [kernel version number]" [ixgbe rpm]` (e.g. `i2_mock --arch i686 -D "kversion 2.6.18-194.32.1.el5.web100" ixgbe-3.1.17-1.src.rpm)

=== myri10ge kernel module ===
  * Copy all the kernel development RPMs (*-devel-*rpm) into the 'holding' repository (i.e. i686, PAE and xen version)
    * Make note of the kernel version number (e.g. 2.6.18-194.32.1.el5.web100)
  * Build a source RPM of the myri10ge module (e.g. myri10ge-1.5.2-0.src.rpm)
    * A copy of the sources/spec file is available at http://anonsvn.internet2.edu/svn/nptoolkit/trunk/software/myri10ge/
  * Run `i2_mock --arch i686 -D "kversion [kernel version number]" [myri10ge rpm]` (e.g. `i2_mock --arch i686 -D "kversion 2.6.18-194.32.1.el5.web100" myri10ge-1.5.2-0.src.rpm


== Last Updated ==

$Id$