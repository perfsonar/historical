#summary CTP Nagios Installation and Configuration

<wiki:toc max_depth="6" />

== Introduction ==

The following outlines the procedure to install Nagios and related plugins to support the ongoing CTP work.  There are two components to this project:

 * _*The Nagios Monitor*_ - Machine that runs the nagios software and performs checks
 * _*The Beacon*_ - Machine houses the CTP data and runs a Nagios Plugin to deliver this back to the Nagios Monitor

Most of this guide will focus on the Monitor as the Beacon is already functional.

== Nagios Monitor ==

This is assumed to be the existing TSG Production Nagios Instance.  The instructions below start from the beginning of the process even though this machine may have nagios installed already.

=== Server Installation ===

There are 3 components that must be installed on this host:

 * [CTPNagios#Nagios Nagios] - The base monitoring package
 * [CTPNagios#NRPE_(Server) NRPE (Server)] - A plugin that allows remote execution on beacon hosts
 * [CTPNagios#PNP PNP] - A plugin that graphs collected performance data

The installation and minor testing of each will be described below.

==== Nagios ====

 # Download Nagios (version 3.0.6 used for this guide):
{{{
http://www.nagios.org/download/download.php
}}}
 # Follow the [http://nagios.sourceforge.net/docs/3_0/toc.html installation guide] for instructions.  

==== NRPE (Server) ====

 # Download NRPE (version 2.12 used for this guide):
{{{
http://www.nagios.org/download/addons/
}}}
 # Follow the [http://nagios.sourceforge.net/docs/nrpe/NRPE.pdf installation guide] for instructions.  
   * Note the Beacon is already configured, _*ndb1.internet2.edu*_
   * Send Jason the address of the Nagios Monitor so he may add it to the _allow list_ for the beacon
 # Once Jason knows the address, and has configured it to accept your host, this test can be attempted:
{{{
/usr/local/nagios/libexec/check_nrpe -H 207.75.164.66 -c check_HOTEL_HARVARD
}}}
   * The results should look like this (if everything was configured properly):
{{{
Arlington VA sending to Cambridge MA|jitter=2.336030

START:		Wed Apr 15 13:03:40 2009 UTC
END:		Wed Apr 15 13:04:21 2009 UTC
LATENCY:	9.03893 ms
JITTER:		2.33603 ms
LOSS:		0%
}}}

==== PNP ====

 # Download PNP (version 0.4.13 used for this guide):
{{{
http://www.pnp4nagios.org/pnp/dwnld
}}}
 # Follow the [http://www.pnp4nagios.org/pnp/doc_complete installation guide] for instructions.
   * Be sure you enable this setting:
{{{
process_performance_data=1
}}} 
   * Note this will collect performance data from other capable plugins as well, not just CTP plugins

=== Server Configuration ===

There are some minor configuration tweaks that must be made to support some of the CTP activities.  

==== nagios.cfg ====

This file is located on our development instance here:

{{{
/usr/local/nagios/etc/nagios.cfg
}}}

Change the following line to allow CGI URLs in the email alerts:

{{{
#illegal_macro_output_chars=`~$&|'"<>
illegal_macro_output_chars=`~$|'"
}}}

==== cgi.cfg ====

This change is _*OPTIONAL*_ but allows guest users access to the nagios status.  This file is located on our development instance here (note that your nagios.cfg may specify this into a different location):

{{{
/usr/local/nagios/etc/cgi.cfg
}}}

Change the following lines to add a _*guest*_ user:

{{{
authorized_for_all_services=nagiosadmin,guest
authorized_for_all_hosts=nagiosadmin,guest
}}}

This will also require a guest user/password be added to:

{{{
/usr/local/nagios/etc/htpasswd.users
}}}

This can be done by doing something like this:

{{{
sudo htpasswd /usr/local/nagios/etc/htpasswd.users guest
}}}

==== commands.cfg ====

This file is located on our development instance here (note that your nagios.cfg may specify this into a different location):

{{{
/usr/local/nagios/etc/objects/commands.cfg
}}}

Change the following item regarding email notifications.  This allows us to send a lot more information than a standard alert.

{{{
# 'notify-service-by-email' command definition
define command{
        command_name    notify-service-by-email
        command_line    /usr/bin/printf "%b" "***** Nagios *****\n\nNotification Type: $NOTIFICATIONTYPE$\n\nService: $SERVICEDESC$\nHost: $HOSTALIAS$\nAddress: $HOSTADDRESS$\nState: $SERVICESTATE$\n\nDate/Time: $LONGDATETIME$\n\nAdditional Info:\n\n$SERVICEOUTPUT$\n\n$LONGSERVICEOUTPUT$\n$SERVICENOTESURL$\n" | /bin/mail -s "** $NOTIFICATIONTYPE$ Service Alert: $HOSTALIAS$/$SERVICEDESC$ is $SERVICESTATE$ **" $CONTACTEMAIL$
        }
}}}

==== Host Configuration ====

Add the following host to whichever file other hosts are stored, ours is stored here (note that your nagios.cfg may specify this into a different location):

{{{
/usr/local/nagios/etc/servers/internet2.cfg
}}}

This is the beacon host, note that the _*use*_ line may change depending on which templates are in use.

{{{
define host{
        host_name       ndb1.internet2.edu
        address         ndb1.internet2.edu
        use             generic-host
        }
}}}

==== Service Configuration ====

Add the following services to whichever file other services are stored, ours is stored here (note that your nagios.cfg may specify this into a different location):

{{{
/usr/local/nagios/etc/servers/internet2.cfg
}}}

These are the CTP services that can be checked on the beacon host.  We are only specifying two right now, but there are 79 others that can be used:

{{{
define service{
        use                     generic-service
        host_name               ndb1.internet2.edu
        service_description     CTP HOTEL - HARVARD        
        check_command           check_nrpe!check_HOTEL_HARVARD
        check_interval          1
        retry_interval          1
        max_check_attempts      1
        notification_interval   60
        notification_options    w,u,c,r
        notes_url               http://ndb1.internet2.edu/cgi-bin/CTP/owamp_path_jitter.cgi?mesh=AA&node=HARVARD&other_node=HOTEL
#       process_perf_data       0
        action_url              /nagios/pnp/index.php?host=ndb1.internet2.edu&srv=CTP_HOTEL_-_HARVARD
        }

define service{
        use                     generic-service
        host_name               ndb1.internet2.edu
        service_description     CTP HARVARD - HOTEL       
        check_command           check_nrpe!check_HARVARD_HOTEL
        check_interval          1
        retry_interval          1
        max_check_attempts      1
        notification_interval   60
        notification_options    w,u,c,r
        notes_url               http://ndb1.internet2.edu/cgi-bin/CTP/owamp_path_jitter.cgi?mesh=AA&node=HOTEL&other_node=HARVARD
#       process_perf_data       0
        action_url              /nagios/pnp/index.php?host=ndb1.internet2.edu&srv=CTP_HARVARD_-_HOTEL
        }
}}}

=== Server Verification ===

Visit the nagios web view to see that the host and service(s) have been added.  The following tests are usually a good idea:

 # On the left side, click on _*Service Detail*_
 # Click on _*CTP HOTEL - HARVARD*_ under _*ndb1.internet2.edu*_
 # On the right side click on _*Re-schedule the next check of this service*_
   * Have this check immediately
 # Wait for the result to arrive, ensure that the plugin is returning something:
   * Green (_*OK*_) - The result will say something similar to:
{{{
Arlington VA sending to Cambridge MA 
}}}
   * Yellow (_*WARNING*_) - The result will say also something similar to (the more detail page will have a reason why):
{{{
Arlington VA sending to Cambridge MA 
}}}
   * RED (_*CRITICAL*_) - The result will say also something similar to (the more detail page will have a reason why):
{{{
Arlington VA sending to Cambridge MA 
}}}
   * RED (_*CRITICAL*_) - The may feature some other kind of warning, this could indicate a problem with communication to the beacon, for example:
{{{
CHECK_NRPE: Error - Could not complete SSL handshake. 
}}}
   * Orange (_*UNKNOWN*_) - This is a message that is thrown when the plugin is being used wrong (wrong arguments), when there is a database problem, or when data may not be available, such as:
{{{
Cannot find most recent data. 
}}}
 # The second test will force a notification to the email list, click on _*Send custom service notification*_
   * Also be sure you have added the necessary folks to the email distribution list, including Aaron, Jason, and Jeff.

Contact Jason if you run into any trouble.

== Nagios Beacon ==

The Nagios beacon is installed on ndb1.internet2.edu already.  The instructions are provided in the event that we require another beacon.  

=== Client Installation ===

There are 2 components that must be installed on this host:

 * [CTPNagios#NRPE_(Client) NRPE (Client)] - A plugin that allows remote execution on beacon hosts and communication back to the monitor
 * [CTPNagios#perfSONAR-PS perfSONAR-PS] - perfSONAR-PS tools, including libraries and the CTP plugin 

The installation and minor testing of each will be described below.

==== NRPE (Client) ====

 # Download NRPE (version 2.12 used for this guide):
{{{
http://www.nagios.org/download/addons/
}}}
 # Follow the [http://nagios.sourceforge.net/docs/nrpe/NRPE.pdf installation guide] for instructions.  

==== perfSONAR-PS ====

 # Download the perfSONAR-PS CTP Branch:
{{{
svn checkout http://anonsvn.internet2.edu/svn/perfSONAR-PS/branches/CTP/
}}}
 # Copy the plugin to the proper location (locations may vary):
{{{
cp ~/CTP/nagios/check_db.pl /usr/local/nagios/libexec
}}}
 # Edit the plugin to point to the correct library:
{{{
use lib "/home/zurawski/CTP/lib";
}}}
 # Install any pre-requisite perl libraries (use CPAN), the plugin requires:
   * DBI
   * Getopt::Long
   * Data::Dumper
 # Ensure the database, _*powmaster.pl*_, and _*powcollector.pl*_ are functioning 
 # Run a test:
{{{
/usr/local/nagios/libexec/check_db.pl --sender=HOTEL --receiver=HARVARD
}}}
   * The results should be similar to:
{{{
Arlington VA sending to Cambridge MA|jitter=2.007960

START:		Wed Apr 15 14:00:24 2009 UTC
END:		Wed Apr 15 14:01:06 2009 UTC
LATENCY:	8.7471 ms
JITTER:		2.00796 ms
LOSS:		0%
}}}

=== Client Configuration ===

There are a couple of minor configuration tweaks to address:

==== nrpe.cfg ====

Edit this file to add commands that can be remotely executed:

{{{
command[check_HOTEL_HARVARD]=/usr/local/nagios/libexec/check_db.pl --sender=HOTEL --receiver=HARVARD
command[check_HARVARD_HOTEL]=/usr/local/nagios/libexec/check_db.pl --sender=HARVARD --receiver=HOTEL
}}}

==== xinitd ====

Edit the _*nrpe*_ conf to add the appropriate servers:

{{{
# default: on
# description: NRPE (Nagios Remote Plugin Executor)
service nrpe
{
        flags           = REUSE
        socket_type     = stream    
        port            = 5666    
        wait            = no
        user            = nagios
        group           = nagios
        server          = /usr/local/nagios/bin/nrpe
        server_args     = -c /usr/local/nagios/etc/nrpe.cfg --inetd
        log_on_failure  += USERID
        disable         = no
        only_from       = 127.0.0.1 207.75.165.160
}
}}}

=== Client Verification ===

See [CTPNagios#Server_Verification Server Verification] for most of the verification.  This simple test can be attempted to check:

{{{
/usr/local/nagios/libexec/check_nrpe -H localhost -c check_HOTEL_HARVARD
}}}

The results should look like this (if everything was configured properly):

{{{
Arlington VA sending to Cambridge MA|jitter=2.336030

START:		Wed Apr 15 13:03:40 2009 UTC
END:		Wed Apr 15 13:04:21 2009 UTC
LATENCY:	9.03893 ms
JITTER:		2.33603 ms
LOSS:		0%
}}}

== Last Updated ==

$Id$


