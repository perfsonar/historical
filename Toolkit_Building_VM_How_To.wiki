#summary Instructions to build the Toolkit Building VM

=Building the Toolkit Building Virtual Machine=

==Create the CentOS Virtual Machine==
  * Download the centos boot.iso from one of these [http://www.centos.org/modules/tinycontent/index.php?id=30 mirrors].
  * I used VMware Fusion 3.1.3 to create a new virtual machine. 
  * Under Settings set the CD ROM drive to load the boot.iso image. 
  * Increase the disk size to 30 GB.

==OS Installation==
  * Start the VM and at the boot prompt type `linux text` 
  * Choose installation method `HTTP` 
  * When prompted, enter the Web Site Name: `ndb1.internet2.edu` 
  * Centos directory: `centos/5.6/os/i386` 
  * Press `OK` until you come to the Time Zone screen.
  * Set your time zone.
  * Continue and set your root password.
  * Continue and uncheck default package selections.
  * Wait for installation to finish.
  * Reboot.

==Configure Services==
  * When the VM reboots you'll be prompted for configuration. Configure the firewall to disable `SELinux` , and under Customize ensure `ssh` is selected.
  * Under System Services disable `anacron, apmd, bluetooth, firstboot, gpm, mdmonitor, pcsd` and `yum-updatesd` 

==Eject Installation Media==
  * Log in as root.
  * Type `shutdown -h now` 
  * After shutdown use Virtual Machine Settings to unmount boot.iso.
  * Start the VM.
  * Log back in as root.

==Install Packages==
  * Install `epel`
{{{ 
rpm -Uvh http://download.fedora.redhat.com/pub/epel/5/i386/epel-release-5-4.noarch.rpm 
}}}
  * Use `yum` to install `kernel-devel, mock, ImageMagic, mkisofs, squashfs-tools, livecd-tools, rpm-build, redhat-rpm-config, unifdef, autoconf, automake, gcc-c++, subversion`

  * You may also need to install `syslinux, anaconda-runtime, make, m4 and binutils` if they're not aleady installed.

==Create psbuild user==
  * Type `useradd -G wheel,mock psbuild` (Note: no space after comma in group list).
  * Change default group to mock with `usermod -g mock psbuild`
  * Give the psbuild user a default password `psbuild0` using the command `passwd psbuild` 
  * Use `/usr/sbin/visudo` to uncomment the line 
{{{ 
%wheel ALL=(ALL) NOPASSWD: ALL
}}}

==Configure the psbuild home directory==
  * Add the following 3 lines to `/etc/mock/epel-5-i386.cfg` 
{{{
[holding]
name=holding
baseurl=file:///home/psbuild/holding
}}}
  * Type the following commands to create toolkit building directories
{{{
mkdir -p /home/psbuild/holding
createrepo -d --update /home/psbuild/holding
mkdir -p /home/psbuild/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
echo '%_topdir %(echo $HOME)/rpmbuild' > /home/psbuild/.rpmmacros
mkdir /home/psbuild/bin
}}}
  * Copy the i2 mock script from `http://code.google.com/p/perfsonar-ps/wiki/ToolkitBuildingFAQs` to `/home/psbuild/bin` 
  * Change the default output directory in the `i2`mock` script from 
{{{ 
$resultdir="/srv/results/$name/$distro/$arch/".`rpm -qp $srpm 2>/dev/null` unless ($resultdir); 
}}}
  * to 
{{{ 
$resultdir="/home/$name/$distro/$arch/".`rpm -qp $srpm 2>/dev/null` unless ($resultdir); 
}}}

==Finish Up==
  * Correct the psbuild user permissions with `chown -R psbuild:mock /home/psbuild`
  * Force the user to change password on first login with `chage -d 0 psbuild` 
  * Disable root account with `passwd -l root` 
  * `exit` 