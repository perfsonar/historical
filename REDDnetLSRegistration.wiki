#summary Registering REDDnet resources with the LS

<wiki:toc max_depth="6" />

== Introduction ==

The following is a description on the messages that are required to register REDDnet depots with the perfSONAR lookup service.  

== Idea ==

http://perfsonar-ps.googlecode.com/svn/wiki/REDDnetLSRegistration/idea.png

Each REDDnet depot will periodically register it's name, location, and address with a local hLS.  The hLS will have the responsibility of continuing the process and interacting with the gLS.  In general there will be 3 interactions the depots must control:

 * [REDDnetLSRegistration#Registration Initial registration] - Adding new information into the hLS
 * [REDDnetLSRegistration#Keepalive Updating registration] - Updating an existing registration
 * [REDDnetLSRegistration#Deregistraton Deregistering] - Removing a registration (e.g. if a depot goes offline)

== Messages ==

The following messages are presented in request/response pairs.  These are XML messages that travel in a SOAP envelope over HTTP.  The SOAP encoding is also presented for clarity.  

=== Registration ===

The registration message sends basic information about the service to the hLS.  The hLS will then store this for some length of time (usually a day) before it has deemed the information _stale_.  Stale information will be automatically cleaned.  It is necessary for services to register on a regular basis to prevent this from happening.  The following is an example of an LS registration message:

{{{
<?xml version="1.0"?>
<SOAP-ENV:Envelope xmlns:SOAP-ENC="http://schemas.xmlsoap.org/soap/encoding/" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/">
  <SOAP-ENV:Header/>
  <SOAP-ENV:Body>
    <nmwg:message type="LSRegisterRequest" id="msg1"
                  xmlns:perfsonar="http://ggf.org/ns/nmwg/tools/org/perfsonar/1.0/"
                  xmlns:nmwg="http://ggf.org/ns/nmwg/base/2.0/"
                  xmlns:psservice="http://ggf.org/ns/nmwg/tools/org/perfsonar/service/1.0/"
                  xmlns:nmwgt="http://ggf.org/ns/nmwg/topology/2.0/"
                  xmlns:nmtb="http://ogf.org/schema/network/topology/base/20070828/"
                  xmlns:nmtl3="http://ogf.org/schema/network/topology/l3/20070828/">
      <nmwg:metadata xmlns:nmwg="http://ggf.org/ns/nmwg/base/2.0/" id="metadata.6108796">
        <perfsonar:subject xmlns:perfsonar="http://ggf.org/ns/nmwg/tools/org/perfsonar/1.0/" id="subject.6108796">
          <nmtb:service xmlns:nmtb="http://ogf.org/schema/network/base/20070828/">
            <nmtb:name>ACCRE REDDnet Depot</nmtb:name>
            <nmtb:type>reddnet</nmtb:type>
            <nmtb:description>REDDnet Depot at ACCRE in Vanderbilt University, Nashville TN USA</nmtb:description>
            <nmtb:address type="uri">tcp://depot4.loc1.vanderbilt.reddnet.org:6714</nmtb:address>
          </nmtb:service>
        </perfsonar:subject>
      </nmwg:metadata>
      <nmwg:data xmlns:nmwg="http://ggf.org/ns/nmwg/base/2.0/" id="data.8951788" metadataIdRef="metadata.6108796">
        <nmwg:metadata id="metadata.8951788">
          <nmwg:subject id="subject.8951788">
            <nmtb:node xmlns:nmtb="http://ogf.org/schema/network/topology/base/20070828/" xmlns:nmtl3="http://ogf.org/schema/network/topology/l3/20070828/">
            </nmtb:node>
          </nmwg:subject>
          <nmwg:eventType>http://ggf.org/ns/nmwg/tools/reddnet/1.0</nmwg:eventType>
          <nmwg:parameters id="parameters.8951788">
            <nmwg:parameter name="keyword">project:REDDnet</nmwg:parameter>
          </nmwg:parameters>
        </nmwg:metadata>
      </nmwg:data>
    </nmwg:message>
  </SOAP-ENV:Body>
</SOAP-ENV:Envelope>
}}}

Observations about the message:

 * There are two main parts:
   * Metadata - contains the _service_ information about the REDDnet depot.  This information may change but consists of:
     * _*name*_ - a localize name, for example: _*ACCRE REDDnet Depot*_
     * _*type*_ - always set this to _*reddnet*_
     * _*description*_ - a localized description that should include a location, for example: _*REDDnet Depot at ACCRE in Vanderbilt University, Nashville TN USA*_
     * _*address*_ - The address and port of the resource, be sure to include both and also start with _*tcp://*_, for example: _*tcp://depot4.loc1.vanderbilt.reddnet.org:6714*_
   * Data - Will eventually contain data about the service.  We have not fully defined this yet, but information regarding capacity or system properties may appear here.  For now use the data section above as is.
 * Some other observations about the XML:
   * XML parsers vary in how they treat namespaces.  It is recommended that the namespaces used in the message be defined there first.  
   * Each element (message, metadata, subject, data, parameters) should have an ID value.  For the most part these may be randomly generated numbers.  There is only one rule: the _*the id of the metadata must be referenced by the data*_.  See the example above, the metadata id is _*metadata.6108796*_ and the data has an idRef set to _*metadata.6108796*_.  This is necessary for message processing.  

After sending the above message to an hLS (e.g. the REDDnet hLS is located here: [http://sc2009.reddnet.org:9995/perfSONAR_PS/services/hLS http://sc2009.reddnet.org:9995/perfSONAR_PS/services/hLS]), the following message is returned.  Note this is a _success_:

{{{
<?xml version="1.0"?>
<SOAP-ENV:Envelope xmlns:SOAP-ENC="http://schemas.xmlsoap.org/soap/encoding/" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/">
  <SOAP-ENV:Header/>
  <SOAP-ENV:Body>
    <nmwg:message xmlns:xsd="http://www.w3.org/2001/XMLSchema/" xmlns:nmwg="http://ggf.org/ns/nmwg/base/2.0/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance/" xmlns:nmtl3="http://ogf.org/schema/network/topology/l3/20070828/" xmlns:SOAP-ENC="http://schemas.xmlsoap.org/soap/encoding/" xmlns:nmwgt="http://ggf.org/ns/nmwg/topology/2.0/" xmlns:perfsonar="http://ggf.org/ns/nmwg/tools/org/perfsonar/1.0/" xmlns:nmtb="http://ogf.org/schema/network/base/20070828/" xmlns:psservice="http://ggf.org/ns/nmwg/tools/org/perfsonar/service/1.0/" messageIdRef="msg1" id="message.11870080" type="LSRegisterResponse">
      <nmwg:metadata metadataIdRef="metadata.6108796" id="metadata.7069141">
        <nmwg:key xmlns:nmwg="http://ggf.org/ns/nmwg/base/2.0/" id="key.12429116">
          <nmwg:parameters id="param.3340513">
            <nmwg:parameter name="lsKey">530ae76b5baaf94b4ef5189244e43353</nmwg:parameter>
          </nmwg:parameters>
        </nmwg:key>
        <nmwg:eventType>success.ls.register</nmwg:eventType>
      </nmwg:metadata>
      <nmwg:data metadataIdRef="metadata.7069141" id="data.14287208">
        <nmwg:datum xmlns:nmwg="http://ggf.org/ns/nmwg/base/2.0/" value="[1] Data elements have been registered with key [530ae76b5baaf94b4ef5189244e43353]"/>
      </nmwg:data>
    </nmwg:message>
  </SOAP-ENV:Body>
</SOAP-ENV:Envelope>
}}}

There are 2 important pieces of info to glean from this message:

 * The _*eventType*_ - this should return as _*success.ls.register*_.  If it returns as anything that starts with _*error*_, there was a problem with registration.  It is recommended that logging indicate this.  
 * The _*datum*_ - there will be one of two things in here:
   * If the result was a _*success.ls.register*_, this value will contain a message that contains a _*registration key*_.  This value should be saved, because it will be necessary for the [REDDnetLSRegistration#Keepalive keepalive] message.
   * If the result was any form of _*error*_, the value will be a reason for the failure, this should be passed to the logs as well.

=== Keepalive ===

The keepalive message is used to update an existing registration.  Use this message _*only*_ after the [REDDnetLSRegistration#Registration registration] message has been used and a key has been returned.  The message is as follows:

{{{
<?xml version="1.0"?>
<SOAP-ENV:Envelope xmlns:SOAP-ENC="http://schemas.xmlsoap.org/soap/encoding/" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/">
  <SOAP-ENV:Header/>
  <SOAP-ENV:Body>
    <nmwg:message type="LSKeepaliveRequest" id="msg3" xmlns:nmwg="http://ggf.org/ns/nmwg/base/2.0/">
      <nmwg:metadata id="key_to_keepalive">
        <nmwg:key>
          <nmwg:parameters id="keys">
            <nmwg:parameter name="lsKey">530ae76b5baaf94b4ef5189244e43353</nmwg:parameter>
          </nmwg:parameters>
        </nmwg:key>
      </nmwg:metadata>     
      <nmwg:data metadataIdRef="key_to_keepalive" id="d1"/>
    </nmwg:message>
  </SOAP-ENV:Body>
</SOAP-ENV:Envelope>
}}}

Observations about the message:

 * There are two main parts:
   * Metadata - contains the _key_ that was returned from the [REDDnetLSRegistration#Registration registration] message
   * Data - is _blank_, but still required.  
 * Some other observations about the XML:
   * As in the [REDDnetLSRegistration#Registration registration] message, be sure that the _metadata id_ and the data element's _idRef_ are the same.  

After sending the above message to an hLS (e.g. the REDDnet hLS is located here: [http://sc2009.reddnet.org:9995/perfSONAR_PS/services/hLS http://sc2009.reddnet.org:9995/perfSONAR_PS/services/hLS]), the following message is returned.  Note this is a _success_:

{{{
<?xml version="1.0"?>
<SOAP-ENV:Envelope xmlns:SOAP-ENC="http://schemas.xmlsoap.org/soap/encoding/" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/">
  <SOAP-ENV:Header/>
  <SOAP-ENV:Body>
    <nmwg:message xmlns:xsd="http://www.w3.org/2001/XMLSchema/" xmlns:nmwg="http://ggf.org/ns/nmwg/base/2.0/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance/" xmlns:SOAP-ENC="http://schemas.xmlsoap.org/soap/encoding/" messageIdRef="msg3" id="message.1455296" type="LSKeepaliveResponse">
      <nmwg:metadata metadataIdRef="key_to_keepalive" id="metadata.6188723">
        <nmwg:eventType>success.ls.keepalive</nmwg:eventType>
      </nmwg:metadata>
      <nmwg:data metadataIdRef="metadata.6188723" id="data.1671099">
        <nmwgr:datum xmlns:nmwgr="http://ggf.org/ns/nmwg/result/2.0/">Key "530ae76b5baaf94b4ef5189244e43353" was updated.</nmwgr:datum>
      </nmwg:data>
    </nmwg:message>
  </SOAP-ENV:Body>
</SOAP-ENV:Envelope>
}}}

There are 2 important pieces of info to glean from this message:

 * The _*eventType*_ - this should return as _*success.ls.keepalive*_.  If it returns as anything that starts with _*error*_, there was a problem with registration.  It is recommended that logging indicate this.  
 * The _*datum*_ - there will be one of two things in here:
   * If the result was a _*success.ls.keepalive*_, this value will contain a message that contains a _*registration key*_.
   * If the result was any form of _*error*_, the value will be a reason for the failure, this should be passed to the logs as well.
   
The following is a typical error message, this would occur if the service _*was not*_ registered with the LS to begin with, or the registration had expired:

{{{
<?xml version="1.0"?>
<SOAP-ENV:Envelope xmlns:SOAP-ENC="http://schemas.xmlsoap.org/soap/encoding/" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/">
  <SOAP-ENV:Header/>
  <SOAP-ENV:Body>
    <nmwg:message xmlns:xsd="http://www.w3.org/2001/XMLSchema/" xmlns:nmwg="http://ggf.org/ns/nmwg/base/2.0/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance/" xmlns:SOAP-ENC="http://schemas.xmlsoap.org/soap/encoding/" messageIdRef="msg3" id="message.4293282" type="LSKeepaliveResponse">
      <nmwg:metadata metadataIdRef="key_to_keepalive" id="metadata.5284854">
        <nmwg:eventType>error.ls.keepalive.key_not_found</nmwg:eventType>
      </nmwg:metadata>
      <nmwg:data metadataIdRef="metadata.5284854" id="data.3446165">
        <nmwgr:datum xmlns:nmwgr="http://ggf.org/ns/nmwg/result/2.0/">Sent key "530ae76b5baaf94b4ef5189244e43353" was not registered.</nmwgr:datum>
      </nmwg:data>
    </nmwg:message>
  </SOAP-ENV:Body>
</SOAP-ENV:Envelope>
}}}

If this message occurs, it is best to have an error routine that is capable of sending a brand new [REDDnetLSRegistration#Registration registration] message.  

=== Deregistraton ===

The deregistration message will remove previously registered information from an hLS.  It is recommended that as a part of the depot shutdown this message be used.  The message is described below:

{{{
<?xml version="1.0"?>
<SOAP-ENV:Envelope xmlns:SOAP-ENC="http://schemas.xmlsoap.org/soap/encoding/" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/">
  <SOAP-ENV:Header/>
  <SOAP-ENV:Body>
    <nmwg:message type="LSDeregisterRequest" id="msg2" xmlns:nmwg="http://ggf.org/ns/nmwg/base/2.0/">
      <nmwg:metadata id="deregister">
        <nmwg:key>
          <nmwg:parameters id="keys">
            <nmwg:parameter name="lsKey">530ae76b5baaf94b4ef5189244e43353</nmwg:parameter>
          </nmwg:parameters>
        </nmwg:key>
      </nmwg:metadata>
      <nmwg:data metadataIdRef="deregister" id="d1"/>
    </nmwg:message>
  </SOAP-ENV:Body>
</SOAP-ENV:Envelope>
}}}

Observations about the message:

 * There are two main parts:
   * Metadata - contains the _key_ that was returned from the [REDDnetLSRegistration#Registration registration] message
   * Data - is _blank_, but still required.  
 * Some other observations about the XML:
   * As in the [REDDnetLSRegistration#Registration registration] and [REDDnetLSRegistration#Keepalive keepalive] messages, be sure that the _metadata id_ and the data element's _idRef_ are the same.  

After sending the above message to an hLS (e.g. the REDDnet hLS is located here: [http://sc2009.reddnet.org:9995/perfSONAR_PS/services/hLS http://sc2009.reddnet.org:9995/perfSONAR_PS/services/hLS]), the following message is returned.  Note this is a _success_:

{{{
<?xml version="1.0"?>
<SOAP-ENV:Envelope xmlns:SOAP-ENC="http://schemas.xmlsoap.org/soap/encoding/" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/">
  <SOAP-ENV:Header/>
  <SOAP-ENV:Body>
    <nmwg:message xmlns:xsd="http://www.w3.org/2001/XMLSchema/" xmlns:nmwg="http://ggf.org/ns/nmwg/base/2.0/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance/" xmlns:SOAP-ENC="http://schemas.xmlsoap.org/soap/encoding/" messageIdRef="msg2" id="message.7705222" type="LSDeregisterResponse">
      <nmwg:metadata metadataIdRef="deregister" id="metadata.17516233">
        <nmwg:eventType>success.ls.deregister</nmwg:eventType>
      </nmwg:metadata>
      <nmwg:data metadataIdRef="metadata.17516233" id="data.11151948">
        <nmwgr:datum xmlns:nmwgr="http://ggf.org/ns/nmwg/result/2.0/">Removed [1] data elements and service info for key "530ae76b5baaf94b4ef5189244e43353".</nmwgr:datum>
      </nmwg:data>
    </nmwg:message>
  </SOAP-ENV:Body>
</SOAP-ENV:Envelope>
}}}

There are 2 important pieces of info to glean from this message:

 * The _*eventType*_ - this should return as _*success.ls.deregister*_.  If it returns as anything that starts with _*error*_, there was a problem with registration.  It is recommended that logging indicate this.  
 * The _*datum*_ - there will be one of two things in here:
   * If the result was a _*success.ls.deregister*_, this value will contain a message that describes the operation.  
   * If the result was any form of _*error*_, the value will be a reason for the failure, this should be passed to the logs as well.
   
The following is a typical error message, this would occur if the service _*was not*_ registered with the LS to begin with, or the registration had expired:

{{{
<?xml version="1.0"?>
<SOAP-ENV:Envelope xmlns:SOAP-ENC="http://schemas.xmlsoap.org/soap/encoding/" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/">
  <SOAP-ENV:Header/>
  <SOAP-ENV:Body>
    <nmwg:message xmlns:xsd="http://www.w3.org/2001/XMLSchema/" xmlns:nmwg="http://ggf.org/ns/nmwg/base/2.0/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance/" xmlns:SOAP-ENC="http://schemas.xmlsoap.org/soap/encoding/" messageIdRef="msg2" id="message.14666728" type="LSDeregisterResponse">
      <nmwg:metadata metadataIdRef="deregister" id="metadata.3377468">
        <nmwg:eventType>error.ls.deregister.key_not_found</nmwg:eventType>
      </nmwg:metadata>
      <nmwg:data metadataIdRef="metadata.3377468" id="data.5920966">
        <nmwgr:datum xmlns:nmwgr="http://ggf.org/ns/nmwg/result/2.0/">Sent key "530ae76b5baaf94b4ef5189244e43353" was not registered.</nmwgr:datum>
      </nmwg:data>
    </nmwg:message>
  </SOAP-ENV:Body>
</SOAP-ENV:Envelope>
}}}

If this message occurs, no further action is required, but the results should be logged.  

== Last Updated ==

$Id$
