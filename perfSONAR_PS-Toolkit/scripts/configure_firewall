#!/bin/bash

iptables-restore < /opt/perfsonar_ps/toolkit/etc/firewall.conf


bwctlparams=("iperf_port" "nuttcp_port" "peer_port")
owampparams=("testports")

bwctlfile="/etc/bwctld/bwctld.conf"
owampfile="/etc/owampd/owampd.conf"

addPortRuleFromFile(){
	file=$1
	params=("${!2}")
	for i in "${params[@]}"
	do
		portrange=`awk -v search="^$i" '$0 ~ search {$1=""; print $0}' $file | sed s/-/:/g`
		cmd0="iptables -I INPUT 1 -m udp -p udp --dport $portrange -j ACCEPT"
		cmd1="iptables -I INPUT 1 -m udp -p udp --sport $portrange -j ACCEPT"
		cmd2="iptables -I INPUT 1 -m state --state NEW,ESTABLISHED -m tcp -p tcp --sport $portrange -j ACCEPT"
		cmd3="iptables -I INPUT 1 -m state --state ESTABLISHED -m tcp -p tcp --sport $portrange -j ACCEPT"
		echo $cmd0
		echo $cmd1
		echo $cmd2
		echo $cmd3
		$cmd0
		$cmd1
		$cmd2
		$cmd3
	done 
}

addPortRuleFromFile $bwctlfile $bwctlparams
addPortRuleFromFile $owampfile $owampparams

iptables-save
