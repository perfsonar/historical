#summary perfSONAR Performance Toolkit v3.3 Upgrade Guide

= Introduction =

This page details the steps required for users to upgrade to version 3.3 from previous versions of the toolkit. This is the first distribution based upon CentOS 6 which introduces numerous major changes at the operating system level.  As a result, some of the steps may be more involved than previous upgrades. Follow the instructions below based on the type of distribution you are upgrading.

= Firewalls and Port Changes =
For this release we have updated some of the default ports used by the tools. The goal is to make it easier to run perfSONAR behind a firewall. Toward that end, many of the defaults were changed to match the recommendations of a draft white paper by the Performance Working Group found [http://stats.es.net/ps-downloads/20130308-Firewall-PerfWG.pdf here]. Many of the port ranges that were updated are those that were previously ephemeral ports. Please review that document if you run the toolkit behind a firewall. For those of you that have set some of the ports to different values, your port ranges should be maintained via the upgrade process. For those just using default values, they will now conform to the aforementioned document. These ports are subject to change prior to the finalization of both 3.3 and the white paper.


= Upgrading a 3.2.x LiveCD Disribution =

Upgrading a LiveCD running Toolkit version 3.2.x to a new LiveCD running 3.3 should be very similar to previous LiveCD upgrades if you have done them in the past. The process involves burning a the latest ISO to a CD, replacing the 3.2 CD in the disk drive and rebooting. Upon reboot, you will need to reset your root password, but all other data and user accounts should be migrated. The exact steps are below:

 # First it is recommended you login to your existing LiveCD and backup your data. This is not strictly required, but will give a fallback option for restoring data if anything goes wrong during the LiveCD upgrade. Follow the steps below to download the backup script, create a backup file, and move the backup file to a remote host.
{{{
wget http://anonsvn.internet2.edu/svn/perfSONAR-PS/trunk/perfSONAR_PS-Toolkit/scripts/ps-toolkit-migrate-backup.sh 
chmod 755 ps-toolkit-migrate-backup.sh 
./ps-toolkit-migrate-backup.sh  ~/ps-toolkit-3.2-backup.tgz
scp ps-toolkit-3.2-backup.tgz user@remotehost.example:ps-toolkit-3.2-backup.tgz
}}}
 # Download the LiveCD iso and md5 checksum [http://software.internet2.edu/pS-Performance_Toolkit/ here]
 # Once downloaded please verify the MD5 sum:
{{{
user@host:~$ md5sum pS-Performance_Toolkit-LiveCD-3.3.2.iso;cat pS-Performance_Toolkit-LiveCD-3.3.2.iso.md5 
f5ed7dda7bd8e3431c2e648effd9b48d  pS-Performance_Toolkit-LiveCD-3.3.2.iso
f5ed7dda7bd8e3431c2e648effd9b48d  pS-Performance_Toolkit-LiveCD-3.3.2.iso
}}}
 # Burn the ISO image to a CD using your favorite CD burning software.
 # Shutdown your 3.2.x Toolkit instance
 # Remove the 3.2.x CD and replace it with the new 3.3 disc
 # Power-on the machine and let it boot.
 # You should see a login screen. You will need to reset the root password. The default password is an empty string. You will be prompted to change the password the first time you login as a root user.
 # All your user accounts, service configurations and performance data should have been migrated. You will need to update your administrative information to conform to the new location fields defined by the toolkit by following the instructions [pSPerformanceToolkit33#Administrative_Information here].
 # Your host should now be successfully upgraded! If you notice any problems with the upgrade process please contact the perfSONAR Toolkit users mailing list (perfsonar-ps-users@internet2.edu).
  * *NOTE:* If your data is not restored properly you can restore it with the backup file created following steps 7-10 of the NetInstall instructions in the section below

_NOTE: If you would like to upgrade a LiveCD installation running 3.2.x to a system running the NetInstall version of 3.3, you may follow the instructions in the section Upgrading a 3.2.x NetInstall Distribution _

= Upgrading a 3.2.x NetInstall Distribution =

Upgrading a 3.2.x NetInstall distribution to 3.3 requires using a script to backup key configuration files, doing a clean 3.3 installation and using a restore script to place your data and configuration on the new installation. You will need a location where you can remotely copy the backup files while you perform the upgrade.  Unlike previous updates, a simple "yum update" will not grab the new distribution. This stems from the migration from CentOS5 to CentOS6. The exact steps are below:
 # Login to you 3.2.x host's command-line interface via SSH or a terminal
 # Download the backup script [http://anonsvn.internet2.edu/svn/perfSONAR-PS/trunk/perfSONAR_PS-Toolkit/scripts/ps-toolkit-migrate-backup.sh here] . You can use the following command to download it directly to your host:
{{{
wget http://anonsvn.internet2.edu/svn/perfSONAR-PS/trunk/perfSONAR_PS-Toolkit/scripts/ps-toolkit-migrate-backup.sh 
}}}
 # Run the following command to make the script executable
{{{
chmod 755 ps-toolkit-migrate-backup.sh 
}}}
 # Run the script giving it the name of the gzipped tarball you would like generated as the only parameter. In the command below, all backups will be stored in the home directory in a file call ps-toolkit-3.2-backup.tgz:
{{{
./ps-toolkit-migrate-backup.sh  ~/ps-toolkit-3.2-backup.tgz
}}}
 # Remotely copy the backup file to a new machine. *NOTE: The backup script saves non-root user accounts/password, test configurations, test data and a few other key service configuration files. It does NOT backup every file on the system, so data in home directories or other changes made outside of the Toolkit GUIs will be not be saved. Please verify you have all your important files, especially if you choose to replace the existing partition in the next step.* You may use a tool such as scp to accomplish the copy task, for example:
{{{
scp ps-toolkit-3.2-backup.tgz user@remotehost.example:ps-toolkit-3.2-backup.tgz
}}}
 # Once you have transferred the backup files off of the old host, you may follow the steps of a clean installation found [pSPerformanceToolkit33#NetInstall_CD here]. You may perform the clean installation on the 3.2 host and remove the old partition or you may choose a new physical host.  Return to these instructions after OS installation is complete. For best results, after the OS install DO NOT create any non-root user or begin reconfiguring any services. You may enable SSH if you don;t have access to the terminal.
 # Login to the system as root
 # Copy the backup tarball (called ps-toolkit-3.2-backup.tgz in our previous examples) generated to the new system. Again, you can use scp or any other remote copy method. 
 # Run the restore script with the following command, replacing ps-toolkit-3.2-backup.tgz with the file path to your backup file generated in previous steps:
{{{
$ /opt/perfsonar_ps/toolkit/scripts/ps-toolkit-migrate-restore.sh ps-toolkit-3.2-backup.tgz
}}}
 # Reboot the host
 # All your user accounts, service configurations and performance data should have been migrated. You will need to update your administrative information to conform to the new location fields defined by the toolkit by following the instructions [pSPerformanceToolkit33#Administrative_Information here].
 # Your host should now be successfully upgraded! If you notice any problems with the upgrade process please contact the perfSONAR Toolkit users mailing list (perfsonar-ps-users@internet2.edu).


= Upgrading versions older than 3.2 =
It is recommend that users of versions of the toolkit prior to 3.2 upgrade to the latest version in the 3.2.x line prior to attempting an upgrade. 