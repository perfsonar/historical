#!/usr/bin/perl -w

use strict;
use warnings;

use Config::General;
use FindBin qw($Bin);
use lib "$Bin/../lib";

use perfSONAR_PS::Client::DCN;
use perfSONAR_PS::Common qw( escapeString );

my $CONFIG_DIRECTORY = "$Bin/../etc";
my $CONFIG_FILE      = $CONFIG_DIRECTORY. "/dcnAdmin.conf";

# Read in configuration information
my $config = new Config::General( $CONFIG_FILE );
my %conf   = $config->getall;

my $INSTANCE = shift;
$INSTANCE = $conf{'ls_instance'} unless ($INSTANCE);

use perfSONAR_PS::Client::DCN;
use Data::Dumper;
use Carp;

croak "Provide hLS url.\n" unless $INSTANCE;

my $source = new perfSONAR_PS::Client::DCN( { instance => $INSTANCE } );

print "name,id,institution,longitude,latitude,keywords\n";

my $map = $source->getMappings;
foreach my $m ( @$map ) {
    print $m->[0] if exists $m->[0] and $m->[0];
    print ",";
    print $m->[1] if exists $m->[0] and $m->[1];
    print ",";
    if ( exists $m->[2] and $m->[2] ) {

       print $m->[2]->{institution} if exists $m->[2]->{institution} and $m->[2]->{institution};
       print ",";
       print $m->[2]->{longitude} if exists $m->[2]->{longitude} and $m->[2]->{longitude};
       print ",";
       print $m->[2]->{latitude} if exists $m->[2]->{latitude} and $m->[2]->{latitude};
       print ",";

        if ( $m->[2]->{keywords} ) {
            my $kwc = 0;
            foreach my $kw ( @{ $m->[2]->{keywords} } ) {
                print ", " if $kwc;
                print $kw;
                $kwc++;
            }
        }
    }
    else {
        print ",,,";
    }
    print "\n";
}
