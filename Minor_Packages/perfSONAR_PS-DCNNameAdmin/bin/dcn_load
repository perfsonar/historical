#!/usr/bin/perl -w

use strict;
use warnings;

use Config::General;
use FindBin qw($Bin);
use lib "$Bin/../lib";

use perfSONAR_PS::Client::DCN;
use Data::Dumper;
use Carp;

my $CONFIG_DIRECTORY = "$Bin/../etc";
my $CONFIG_FILE      = $CONFIG_DIRECTORY. "/dcnAdmin.conf";

# Read in configuration information
my $config = new Config::General( $CONFIG_FILE );
my %conf   = $config->getall;

my $FILE     = shift;
my $INSTANCE = shift;
$INSTANCE = $conf{'ls_instance'} unless ($INSTANCE);

croak "Provide input file.\n" unless $FILE;
croak "Provide LS url.\n" unless $INSTANCE;

my $dcn = new perfSONAR_PS::Client::DCN( { instance => $INSTANCE, myAddress => "https://dcn-ls.internet2.edu", myName => "DCN Registration CGI", myType => "dcnmap" } );

open( IN, "<" . $FILE );
my $counter = 0;
while ( <IN> ) {
    print $_ , "\n\n\n";
    if ( $counter ) {
        my @fields = split( /,/, $_ );

        my @temp = ();
        for( my $x = 5; $x <= $#fields; $x++ ) {
            push @temp, $fields[$x];
        }

        my $code = $dcn->insert( { name => $fields[0], id => $fields[1], institution => $fields[2], longitude => $fields[3], latitude => $fields[4], keywords => \@temp } );
        unless ( $code == 0 ) {
            print "FAIL: " , $_ , "\n";
        }

    }
    $counter++;
}
my @content = <IN>;
close(IN);
