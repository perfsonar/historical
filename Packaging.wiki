#summary An overview of the perfSONAR-PS Packaging Process
= Packaging Overview =
The packaging process has changed notedly from previous instances. Before, we created a single CPAN package for each perfSONAR Perl Module. There were some downsides to this approach.

  # There were a large number of packages. Had we done another release with the updates tools, there would have been at least 30 packages.
  # By default, CPAN installed all the modules into the global perl namespace. This makes it difficult to update the services independently, as new versions of the common modules might be installed, which older services might not be compatible with.
  # It made it difficult to distribute things like documentation and configuration files, as it required code to be written to install everything beyond the perl modules and scripts
  # It was difficult to segregate the perfSONAR_PS services from the rest of the system

The new style of package is different. Each package is now installed in its own directory. This directory contains the service's configuration files, its documentation, any scripts or utilities used to interact with the service, the required perfSONAR Perl modules, and any other desired files. The directory layout for the average package will look like this:

{{{
  bin - the location of any service daemons
  etc - the location of any configuration files
  scripts - any utility scripts that interact with the service (e.g. the init script, a script to create a database, etc)
  doc - the documentation
  lib - the perfSONAR_PS modules that this package depends on
}}}

= Creating a New Package =
  # run "svn export perfSONAR_PS-Skeleton perfSONAR_PS-[Package]"
    * This will create a directory perfSONAR-[PackageName] with some basic files in it.
  # Edit the Makefile and change names as appropriate "SkeletonPackage" and "skeleton_package"
    * The ROOTPATH will be the default path that your package will be installed to. It should be something like "/opt/perfsonar_ps/[package_name]".
  # Add any daemons into bin/, symlinking them if they're common scripts in the trunk/scripts directory.
  # Add the daemons to MANIFEST
    * e.g. bin/daemon.pl
  # Copy the init script to start your daemon to the scripts directory
  # Edit the init script and make sure that all the paths make sense and are relative to a PREFIX variable.
{{{
       PREFIX=/opt/perfsonar_ps/skeleton
       DAEMON=$PREFIX/bin/daemon.pl
       CONFFILE=$PREFIX/etc/daemon.conf
}}}
  # Add high-level required .pm files to your MANIFEST
    * This is only necessary if, for example, you're packaging the pSPS daemon + pSB MA, you'd need to specify "lib/perfSONAR_PS/Services/MA/perfSONARBUOY.pm".
    * Note: you do not have to symlink the .pm files as a script will do that for you.
  # Generate the dependencies with "perl ../package_dependencies.pl"
    * This will symlink the modules in from their location in "lib", if the file doesn't already exist, and update the MANIFEST accordingly.
    * It will also create a "dependencies" file containing the perl modules that are required
  # Double-check that all the dependencies make sense
  # Add in default configuration for your service into "etc/"
  # Add any desired documentation into the doc/ folder
  # Move the .spec file to a more appropriate name: perl-perfSONAR_PS-[Service].spec
  # Edit up perl-perfSONAR_PS-ServiceName.spec
    # Change all the references to "skeleton" and "Skeleton" to your package name
    # set %install_base to something appropriate for that installation
    # set %init_script_1 to your init script copied to the scripts directory
    # if you have multiple init scripts, uncomment %init_script_2 and set to the script name. In the %install section, uncomment the lines referencing init_script_2
    # Add the dependencies from the file "dependencies" into it.
  # Run "perl ../package_findunpackaged.pl" and add any files to the MANIFEST
  # Run make dist
  # Copy the service tarball to ~/rpm/SOURCES
    * Note: ~/rpm is your rpm build directory

Building the RPM:

  # run "make dist"
  # copy the perfSONAR_PS-[PackageName].tar.gz to your rpm SOURCES directory
  # run "rpmbuild -ba perl-perfSONAR_PS-[PackageName].spec" to build the RPM